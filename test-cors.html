<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORS Test - Puerto 8080</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #45a049; }
    button.danger { background: #f44336; }
    button.danger:hover { background: #da190b; }
    .result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    input {
      padding: 8px;
      width: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    label {
      display: inline-block;
      width: 100px;
      font-weight: bold;
    }
    .form-group {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ”’ Prueba de CORS - Puerto 8080</h1>
  <p><strong>Servidor:</strong> http://localhost:8080 â†’ <strong>API:</strong> http://localhost:3001</p>

  <!-- Config -->
  <div class="test-section">
    <h2>âš™ï¸ ConfiguraciÃ³n</h2>
    <div class="form-group">
      <label>API URL:</label>
      <input type="text" id="apiUrl" value="http://localhost:3001/api">
    </div>
    <div class="form-group">
      <label>Token JWT:</label>
      <input type="text" id="jwtToken" placeholder="Pega aquÃ­ tu access token (opcional)">
    </div>
  </div>

  <!-- Test 1: Sin credenciales -->
  <div class="test-section">
    <h2>ğŸ“¡ Test 1: PeticiÃ³n SIN credenciales (credentials: omit)</h2>
    <p>Esta peticiÃ³n NO enviarÃ¡ cookies ni headers de autorizaciÃ³n.</p>
    <button onclick="testWithoutCredentials()">ğŸš€ Ejecutar Test</button>
    <div id="result1"></div>
  </div>

  <!-- Test 2: Con credenciales pero sin token -->
  <div class="test-section">
    <h2>ğŸ” Test 2: PeticiÃ³n CON credenciales pero sin token (credentials: include)</h2>
    <p>Esta peticiÃ³n enviarÃ¡ cookies (si existen) pero sin Authorization header.</p>
    <button onclick="testWithCredentials()">ğŸš€ Ejecutar Test</button>
    <div id="result2"></div>
  </div>

  <!-- Test 3: Con credenciales y token JWT -->
  <div class="test-section">
    <h2>ğŸ”‘ Test 3: PeticiÃ³n CON credenciales + Authorization header</h2>
    <p>Esta peticiÃ³n enviarÃ¡ cookies Y el token JWT en el header Authorization.</p>
    <button onclick="testWithJWT()">ğŸš€ Ejecutar Test</button>
    <div id="result3"></div>
  </div>

  <!-- Test 4: Preflight (OPTIONS) -->
  <div class="test-section">
    <h2>ğŸ” Test 4: PeticiÃ³n PREFLIGHT (OPTIONS)</h2>
    <p>Muestra los headers CORS que retorna el servidor.</p>
    <button onclick="testPreflight()">ğŸš€ Ejecutar Test</button>
    <div id="result4"></div>
  </div>

  <!-- Test 5: POST con credenciales -->
  <div class="test-section">
    <h2>ğŸ“® Test 5: POST CON credenciales (simular login)</h2>
    <p>Prueba un POST con JSON body y credenciales.</p>
    <button onclick="testPostWithCredentials()">ğŸš€ Ejecutar Test</button>
    <div id="result5"></div>
  </div>

  <script>
    const getApiUrl = () => document.getElementById('apiUrl').value;
    const getToken = () => document.getElementById('jwtToken').value.trim();

    function showResult(elementId, message, type = 'info') {
      const result = document.getElementById(elementId);
      result.className = `result ${type}`;
      result.textContent = message;
    }

    // Test 1: Sin credenciales
    async function testWithoutCredentials() {
      const url = `${getApiUrl()}/users`;
      showResult('result1', 'â³ Realizando peticiÃ³n...', 'info');

      try {
        const response = await fetch(url, {
          method: 'GET',
          credentials: 'omit', // â† No enviar cookies ni credenciales
        });

        const data = await response.json();
        const message = `âœ… Respuesta exitosa (${response.status})\n\n` +
                       `Headers CORS:\n` +
                       `  Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin')}\n` +
                       `  Access-Control-Allow-Credentials: ${response.headers.get('Access-Control-Allow-Credentials')}\n\n` +
                       `Datos recibidos:\n${JSON.stringify(data, null, 2)}`;
        showResult('result1', message, 'success');
      } catch (error) {
        const message = `âŒ Error CORS:\n\n${error.message}\n\n` +
                       `Esto significa que el servidor rechazÃ³ la peticiÃ³n.\n` +
                       `Verifica que CORS_ORIGIN incluya: http://localhost:8080`;
        showResult('result1', message, 'error');
      }
    }

    // Test 2: Con credenciales pero sin token
    async function testWithCredentials() {
      const url = `${getApiUrl()}/users`;
      showResult('result2', 'â³ Realizando peticiÃ³n...', 'info');

      try {
        const response = await fetch(url, {
          method: 'GET',
          credentials: 'include', // â† Enviar cookies
        });

        const data = await response.json();
        const message = `âœ… Respuesta exitosa (${response.status})\n\n` +
                       `Headers CORS:\n` +
                       `  Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin')}\n` +
                       `  Access-Control-Allow-Credentials: ${response.headers.get('Access-Control-Allow-Credentials')}\n\n` +
                       `Datos recibidos:\n${JSON.stringify(data, null, 2)}`;
        showResult('result2', message, 'success');
      } catch (error) {
        const message = `âŒ Error CORS:\n\n${error.message}\n\n` +
                       `Si ves "Credential is not supported if the CORS header 'Access-Control-Allow-Origin' is '*'"\n` +
                       `significa que CORS_ORIGIN estÃ¡ en '*' (wildcard) y no puede usar credentials.\n\n` +
                       `SoluciÃ³n: Cambia CORS_ORIGIN=http://localhost:8080`;
        showResult('result2', message, 'error');
      }
    }

    // Test 3: Con JWT
    async function testWithJWT() {
      const url = `${getApiUrl()}/users`;
      const token = getToken();

      if (!token) {
        showResult('result3', 'âš ï¸ Por favor ingresa un token JWT vÃ¡lido arriba', 'error');
        return;
      }

      showResult('result3', 'â³ Realizando peticiÃ³n con Authorization header...', 'info');

      try {
        const response = await fetch(url, {
          method: 'GET',
          credentials: 'include', // â† Enviar cookies
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });

        const data = await response.json();
        const message = `âœ… Respuesta exitosa (${response.status})\n\n` +
                       `Headers CORS:\n` +
                       `  Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin')}\n` +
                       `  Access-Control-Allow-Credentials: ${response.headers.get('Access-Control-Allow-Credentials')}\n\n` +
                       `Datos recibidos:\n${JSON.stringify(data, null, 2)}`;
        showResult('result3', message, 'success');
      } catch (error) {
        const message = `âŒ Error:\n\n${error.message}\n\n` +
                       `Posibles causas:\n` +
                       `1. Token JWT invÃ¡lido o expirado\n` +
                       `2. CORS no permite Authorization header\n` +
                       `3. CORS_ORIGIN no incluye http://localhost:8080`;
        showResult('result3', message, 'error');
      }
    }

    // Test 4: Preflight
    async function testPreflight() {
      const url = `${getApiUrl()}/users`;
      showResult('result4', 'â³ Realizando peticiÃ³n OPTIONS (preflight)...', 'info');

      try {
        const response = await fetch(url, {
          method: 'OPTIONS',
        });

        const message = `âœ… Preflight exitoso (${response.status})\n\n` +
                       `CORS Headers retornados:\n` +
                       `  Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin')}\n` +
                       `  Access-Control-Allow-Methods: ${response.headers.get('Access-Control-Allow-Methods')}\n` +
                       `  Access-Control-Allow-Headers: ${response.headers.get('Access-Control-Allow-Headers')}\n` +
                       `  Access-Control-Allow-Credentials: ${response.headers.get('Access-Control-Allow-Credentials')}\n` +
                       `  Access-Control-Max-Age: ${response.headers.get('Access-Control-Max-Age')}`;
        showResult('result4', message, 'success');
      } catch (error) {
        const message = `âŒ Error CORS:\n\n${error.message}`;
        showResult('result4', message, 'error');
      }
    }

    // Test 5: POST
    async function testPostWithCredentials() {
      const url = `${getApiUrl()}/auth/login`;
      showResult('result5', 'â³ Realizando POST con credenciales...', 'info');

      try {
        const response = await fetch(url, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: 'test@example.com',
            password: 'test123'
          })
        });

        const data = await response.json();
        const message = `${response.ok ? 'âœ…' : 'âš ï¸'} Respuesta recibida (${response.status})\n\n` +
                       `Headers CORS:\n` +
                       `  Access-Control-Allow-Origin: ${response.headers.get('Access-Control-Allow-Origin')}\n` +
                       `  Access-Control-Allow-Credentials: ${response.headers.get('Access-Control-Allow-Credentials')}\n\n` +
                       `Datos recibidos:\n${JSON.stringify(data, null, 2)}\n\n` +
                       `${response.ok ? 'Login exitoso' : 'Credenciales incorrectas (esperado, solo es una prueba)'}`;
        showResult('result5', message, response.ok ? 'success' : 'info');
      } catch (error) {
        const message = `âŒ Error CORS:\n\n${error.message}\n\n` +
                       `El POST fue bloqueado por CORS.\n` +
                       `Verifica que CORS_ORIGIN incluya: http://localhost:8080`;
        showResult('result5', message, 'error');
      }
    }

    // Auto-ejecutar test bÃ¡sico al cargar
    window.addEventListener('load', () => {
      console.log('ğŸ” PÃ¡gina de prueba CORS cargada en http://localhost:8080');
      console.log('ğŸ¯ API objetivo:', getApiUrl());
    });
  </script>
</body>
</html>
